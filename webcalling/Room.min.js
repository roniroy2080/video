let configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},peerConnection=new RTCPeerConnection(configuration),socket=null,datachannel=peerConnection.createDataChannel("msg"),user_joined_name=localStorage.getItem("NAME"),user_joined_password=localStorage.getItem("PASSWORD"),user_joined_room_ID=localStorage.getItem("ROOM-ID");document.getElementById("room_detail_name_modal").innerHTML=user_joined_name||"NO NAME",document.getElementById("room_detail_room_id_modal").innerHTML=user_joined_room_ID,document.getElementById("room_detail_password_modal").innerHTML=user_joined_password;let OTHERS_ROOM_ID,Successfully_joined_room_by_local_user,My_uuid,local_video_stream,Remote_username,MY_ROOM_ID=user_joined_room_ID+user_joined_password,i_joined_success_return_from_socket=!1,toast_text=document.getElementById("snackbar");document.getElementById("logout_room").onclick=(()=>{localStorage.removeItem("NAME"),localStorage.removeItem("PASSWORD"),localStorage.removeItem("ROOM-ID"),window.location.href="index"});let checking_ISLOGIN=()=>{localStorage.getItem("NAME")||localStorage.getItem("PASSWORD")||localStorage.getItem("ROOM-ID")||(window.location.href="index")};checking_ISLOGIN();let room_joining_modal_btn=document.getElementById("room_joining_modal_btn"),room_joined_by_own_id_pass_btn=document.getElementById("room_joining_by_own_id_btn"),join_room_close_modal_btn=document.getElementById("join_room_close_modal_btn"),leave_room_btn=document.getElementById("leave_room_btn"),leave_modal_room_id=document.getElementById("leave_room_id_modal"),local_user_join_or_not=document.getElementById("local_user_join_or_not"),other_joined_or_not=document.getElementById("other_joined_or_not"),call_btn=document.getElementById("call_btn"),msg_part=document.getElementById("message_part_get_send"),loading_on_call_btn=document.getElementById("loading_on_call_btn"),call_incoming_alert=document.getElementById("call_incoming_alert"),mute_btn=document.getElementById("mute_btn"),stream_stop_btn=document.getElementById("stream_stop_btn"),msg_send_btn=document.getElementById("msg_send_btn_modal"),local_video=document.getElementById("local_video"),Remote_video=document.getElementById("Remote_video"),generate_random_num=()=>{_sym="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",str="";for(var e=0;e<50;e++)str+=_sym[parseInt(Math.random()*_sym.length)];return str};room_joining_modal_btn.addEventListener("click",()=>{var e=document.getElementById("room__join_modal");e=e.value.trim();var o=document.getElementById("room__password_join_modal");o=o.value.trim(),e.length>0&&o.length>0?Successfully_joined_room_by_local_user&&0!=i_joined_success_return_from_socket?(toast_text.innerHTML="You Are Already Joined To A Room",toast()):(socket=io("https://v-calling.onrender.com"),document.getElementById("room__join_modal").value=null,document.getElementById("room__password_join_modal").value=null,OTHERS_ROOM_ID=e+o,My_uuid=generate_random_num(),socket.emit("joining:room",{to:OTHERS_ROOM_ID,name:user_joined_name,uuid:My_uuid}),Successfully_joined_room_by_local_user=OTHERS_ROOM_ID,join_room_close_modal_btn.click(),socket_functions(),prevent_reload()):alert("Enter Room-ID & Password")}),room_joined_by_own_id_pass_btn.onclick=(()=>{Successfully_joined_room_by_local_user&&0!=i_joined_success_return_from_socket?(toast_text.innerHTML="You Are Already Joined To A Room",toast()):(socket=io("https://v-calling.onrender.com"),document.getElementById("room__join_modal").value=null,document.getElementById("room__password_join_modal").value=null,My_uuid=generate_random_num(),socket.emit("joining:room",{to:MY_ROOM_ID,name:user_joined_name,uuid:My_uuid}),join_room_close_modal_btn.click(),Successfully_joined_room_by_local_user=MY_ROOM_ID,socket_functions(),prevent_reload())});let disabled_after_joined_room=e=>{room_joining_modal_btn.disabled="true",room_joined_by_own_id_pass_btn.disabled="true",My_uuid="",leave_room_btn.disabled="",leave_modal_room_id.innerHTML=e};datachannel.onopen=(()=>{msg_send_btn.disabled="",document.getElementById("msg_input_modal").disabled=""}),datachannel.onclose=(()=>{document.getElementById("msg_input_modal").disabled="true",msg_send_btn.disabled="true"});let somebody_leave_room_from_other_end=()=>{toast_text.innerHTML=`${Remote_username} Leave Room`,toast(),local_video_stream&&local_video_stream.getTracks().forEach(e=>{e.stop()}),local_video_stream=null,peerConnection.ontrack=null,local_user_join_or_not.innerHTML="Disconnected",other_joined_or_not.innerHTML=`${Remote_username} Leave`,peerConnection.close(),socket.disconnect(),datachannel.close(),document.getElementById("local_video").srcObject=null,document.getElementById("Remote_video").srcObject=null,configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},peerConnection=new RTCPeerConnection(configuration),leave_room_btn.disabled="true",room_joining_modal_btn.disabled="",room_joined_by_own_id_pass_btn.disabled="",Successfully_joined_room_by_local_user="",mute_btn.disabled="true",call_btn.disabled="true",stream_stop_btn.disabled="true",leave_modal_room_id.innerHTML="No Data"};datachannel.onclosing=(()=>{somebody_leave_room_from_other_end()}),leave_room_btn.onclick=(()=>{Successfully_joined_room_by_local_user?(stream_stop_btn.disabled="",mute_btn.disabled="",leave_modal_room_id.innerHTML="No Data",toast_text.innerHTML="Exist Room Successfully",toast(),document.getElementById("leave_room_close_modal_btn").click(),leave_room_btn.disabled="true",room_joining_modal_btn.disabled="",room_joined_by_own_id_pass_btn.disabled="",Successfully_joined_room_by_local_user=null,local_video_stream&&local_video_stream.getTracks().forEach(e=>{e.stop()}),document.getElementById("local_video").srcObject=null,document.getElementById("Remote_video").srcObject=null,local_video_stream=null,peerConnection.ontrack=null,datachannel.close(),peerConnection.close(),call_btn.disabled="true",local_user_join_or_not.innerHTML="Leave Room",document.querySelector(".lds-facebook").style.display="none",other_joined_or_not.innerHTML="NO USER",socket.disconnect(),configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},peerConnection=new RTCPeerConnection(configuration)):(toast_text.innerHTML="You Not Joined Any Room",toast())});let prevent_reload=()=>{window.onbeforeunload=(e=>(e.preventDefault(),"Sure?"))},getOffer=async()=>{let e=await peerConnection.createOffer();return await peerConnection.setLocalDescription(e),e},getAnswer=async e=>{await peerConnection.setRemoteDescription(new RTCSessionDescription(e));let o=await peerConnection.createAnswer();return await peerConnection.setLocalDescription(o),o},streaming=async()=>{const e=window.constraints={audio:!0,video:!0};let o=await navigator.mediaDevices.getUserMedia(e);local_video_stream=o;let n=document.getElementById("local_video");return n.srcObject=local_video_stream,"accepted"},sharing_stream=()=>{local_video_stream.getTracks().forEach(e=>{peerConnection.addTrack(e,local_video_stream)})};peerConnection.ontrack=(e=>{let o=document.getElementById("Remote_video");o.srcObject=e.streams[0]});let socket_functions=()=>{socket.on("room:full",e=>{""!==My_uuid&&(e==My_uuid?(toast_text.innerHTML="Room Full !!",toast()):(toast_text.innerHTML="Something Went Wrong",toast()))}),socket.on("i:joined:successfully",()=>{toast_text.innerHTML=`Successfully Joined Room ${Successfully_joined_room_by_local_user}`,toast(),disabled_after_joined_room(Successfully_joined_room_by_local_user),local_user_join_or_not.innerHTML="Joined",document.querySelector(".lds-facebook").style.display="block"}),socket.on("other:joined:room",async e=>{Remote_username=e,other_joined_or_not.innerHTML=`${e} Joined`,document.getElementById("call_incoming_user_name").innerHTML=e;let o=await getOffer();socket.emit("other:joined:success",{to:Successfully_joined_room_by_local_user,name:user_joined_name,offer:o}),document.querySelector(".lds-facebook").style.display="none",toast_text.innerHTML=`You Are Connected To ${e}`,toast(),call_btn.disabled=""}),socket.on("other:joined:room:success",async e=>{disabled_after_joined_room(Successfully_joined_room_by_local_user);let{name:o,offer:n}=e;Remote_username=o,local_user_join_or_not.innerHTML="Joined",other_joined_or_not.innerHTML=`${o} Joined`,document.getElementById("call_incoming_user_name").innerHTML=o,toast_text.innerHTML=`You Are Connected To ${o}`,toast();let t=await getAnswer(n);call_btn.disabled="",socket.emit("answer:server",{to:Successfully_joined_room_by_local_user,answer:t})}),socket.on("answer:client",async e=>{await peerConnection.setRemoteDescription(new RTCSessionDescription(e))}),socket.on("nego:offer:client",async e=>{let o=await getAnswer(e);socket.emit("nego:answer:server",{to:Successfully_joined_room_by_local_user,answer:o})}),socket.on("nego:answer:client",async e=>(await peerConnection.setRemoteDescription(new RTCSessionDescription(e)),socket.off("nego:answer:client")))};call_btn.onclick=(async()=>{loading_on_call_btn.style.display="block",call_btn.disabled="true";try{let e=await streaming();"accepted"==e&&datachannel.send(JSON.stringify({code:"calling_user_other_____"}))}catch(e){loading_on_call_btn.style.display="none",call_btn.disabled=""}});let call_incoming_now,call_reject_btn=document.getElementById("call_reject_btn"),call_accept_btn=document.getElementById("call_accept_btn"),share_mute_btn_disable_false=()=>{stream_stop_btn.disabled="",mute_btn.disabled=""};call_accept_btn.onclick=(async()=>{if(call_incoming_now){call_incoming_now=!1;try{let e=await streaming();"accepted"==e&&(call_incoming_alert.style.display="none",call_btn.disabled="true",sharing_stream(),share_mute_btn_disable_false(),datachannel.send(JSON.stringify({code:"call__accepted_by_user_other_____"})))}catch(e){call_not_accepted("Stream Does Not Share"),call_incoming_alert.style.display="none",call_btn.disabled=""}}}),call_reject_btn.onclick=(()=>{call_incoming_now&&(call_incoming_now=!1,call_btn.disabled="",call_not_accepted("Call Rejected"),call_incoming_alert.style.display="none")});let call_incoming=()=>{call_incoming_now=!0,call_incoming_alert.style.display="flex",call_btn.disabled="true",setTimeout(()=>{1==call_incoming_now&&(call_incoming_now=!1,call_btn.disabled="",call_not_accepted("Call Not PickUp !!"),call_incoming_alert.style.display="none")},1e4)},call_not_accepted=e=>{datachannel.send(JSON.stringify({code:"call_not_accepted_by_user_other_____",reason:e}))},call_accepted=async()=>{share_mute_btn_disable_false(),setTimeout(()=>{sharing_stream()},1500),toast_text.innerHTML="Call Accepted",toast(),loading_on_call_btn.style.display="none",call_btn.disabled="true"},call_rejected=e=>{toast_text.innerHTML=`${e}`,toast(),loading_on_call_btn.style.display="none",call_btn.disabled=""};peerConnection.ondatachannel=(e=>{if("open"==datachannel.readyState){let o=e.channel;o.onmessage=(e=>{let o=JSON.parse(e.data);if("msg_box_focus"==o.code){let e=document.createElement("p");e.innerHTML=`\n                <p id='focus_msg_box'><span style="font-weight: 400;color: red;">${o.to}</span> : <span style="line-height: 1.25rem;">Typing ....</span></p>\n                `,msg_part.prepend(e)}else if("msg_box_blur"==o.code)document.getElementById("focus_msg_box")&&document.getElementById("focus_msg_box").remove();else if("calling_user_other_____"==o.code)call_incoming();else if("call_not_accepted_by_user_other_____"==o.code)call_rejected(o.reason);else if("call__accepted_by_user_other_____"==o.code)call_accepted();else{let e=document.createElement("p");e.innerHTML=`\n                <p><span style="font-weight: 900;color: red;">${o.to}</span> : <span style="line-height: 1.25rem;">${o.msg}</span></p>\n                `,msg_part.prepend(e)}})}else alert("Something Went Wrong. Please Refresh Page !")}),peerConnection.onnegotiationneeded=(async()=>{try{let e=await getOffer();socket.emit("nego:offer:server",{to:Successfully_joined_room_by_local_user,offer:e})}catch(e){}}),document.getElementById("msg_input_modal").onfocus=(()=>{datachannel.send(JSON.stringify({code:"msg_box_focus",to:user_joined_name})),document.getElementById("msg_input_modal").onblur=(()=>{datachannel.send(JSON.stringify({code:"msg_box_blur",to:user_joined_name}))})}),msg_send_btn.onclick=(()=>{let e=document.getElementById("msg_input_modal");if(e=e.value.trim(),"open"==datachannel.readyState)if(e.length>0){let o=document.createElement("p");o.innerHTML=`\n            <p><span style="font-weight: 900;color: blue;">ME</span> : <span style="line-height: 1.25rem;">${e}</span></p>\n            `,msg_part.prepend(o),datachannel.send(JSON.stringify({msg:e,to:user_joined_name})),document.getElementById("msg_input_modal").value=null}else alert("Please Enter Message ...");else alert("Not Connected To Anyone")});let isMute=!1;mute_btn.onclick=(()=>{local_video_stream?local_video_stream.getTracks().forEach(e=>{"audio"==e.kind&&(isMute=!isMute,isMute?(mute_btn.innerHTML="UnMute",e.enabled=!1):(e.enabled=!0,mute_btn.innerHTML="Mute"))}):(toast_text.innerHTML="Your Stream Does Not Exist",toast())});let isSTREAM=!0;stream_stop_btn.onclick=(()=>{local_video_stream?local_video_stream.getVideoTracks().forEach(e=>{isSTREAM=!isSTREAM,isSTREAM?(stream_stop_btn.innerHTML="STOP STREAM",e.enabled=!0):(stream_stop_btn.innerHTML="SHARE STREAM",e.enabled=!1)}):(toast_text.innerHTML="Your Stream Does Not Exist",toast())});